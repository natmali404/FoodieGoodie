{% extends "base.html" %}

{% block title %}{{ przepis.nazwaPrzepisu }}{% endblock %}
{% load static %}

{% block template_stylesheets %}
<link rel="stylesheet" href="{% static 'css/recipe_detail.css' %}">
{% endblock %}

{% block content %}
{% if error != ""  %}
<script>
    alert("Błąd: {{ error }}");
</script>
{% endif %}

<div class="przepis-detail">
    <div class="main-content" id="main-content">
        <div class="info-container" >
            <div>        
                <h1>{{ przepis.nazwaPrzepisu }}</h1>
                       
                <p>
                    <span style="font-size: 0.9rem;"> Opublikowano: {{ przepis.dataPublikacji }}</span>
                </p>
            </div>   
                    
                    
                <p>
                    <img src="{% static 'img/time.jfif' %}" alt="Time Icon" class="icon" >
                    <span>{{ przepis.czasprzygotowania }} min</span>
                </p>
                <p>
                    <img src="{% static 'img/porcja.webp' %}" alt="Portion Icon" class="icon">
                    <span>
                        <form method="POST" id="portion-form">
                            {% csrf_token %}
                            <select id="porcja_select" name="porcja_select" onchange="document.getElementById('portion-form').submit();">
                                {% for i in liczby %}
                                <option value="{{ i }}" {% if i == porcja %}selected{% endif %}>{{ i }} os</option>
                                {% endfor %}
                            </select>
                        </form>
                    </span>
                </p>
        </div>
             
    
    
    
    <h3>Składniki</h3>
    <ul>
        {% for skladnik_przepisu in skladniki_przepisu %}
        <li>{{ skladnik_przepisu.nazwaSkladnika }}: {{ skladnik_przepisu.ilosc }} {{ skladnik_przepisu.jednostka.nazwaJednostki }}</li>
        {% endfor %}
    </ul>
    <h3>Instrukcje</h3>
    <ol>
        {% for instrukcja in przepis.instrukcje %}
        <li>{{ instrukcja }}</li>
        {% endfor %}
    </ol>
    <h3>Wartości odżywcze</h3>
    <table class="nutrition-table">
        <thead>
            <tr>
                <th>Składnik odżywczy</th>
                <th>W porcji</th>
            </tr>
        </thead>
        <tbody>
            {% for klucz, wartosc in przepis.wartosciodzywcze.items %}
            <tr>
                <td>{{ klucz }}</td>
                <td>{{ wartosc }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    <div class="sidebar">
        <form method="POST" action="{% url 'obserw' id=przepis.idPrzepis %}">
            {% csrf_token %}
            <button type="submit" style="width: 100%;">
                {% if obserwowanie == True %}
                    Przestań obserwować
                {% else %}
                    Obserwuj
                {% endif %}
            </button>
        </form>    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
        <script>
           function printContent() {
    // Pobieramy zawartość kontenera
    var content = document.getElementById("main-content").innerHTML;

    // Pobieramy zawartość całej strony
    var originalContent = document.body.innerHTML;

    // Ścieżka do CSS
    var cssPath = "{% static 'css/style.css' %}";

    // Tworzymy tymczasowy widok z CSS
    document.body.innerHTML = `
        <html>
            <head>
                <title>Drukowanie</title>
                <link rel="stylesheet" type="text/css" href="${cssPath}">
            </head>
            <body>${content}</body>
        </html>
    `;

    // Uruchamiamy drukowanie
    window.print();

    // Przywracamy oryginalną zawartość strony
    document.body.innerHTML = originalContent;

    // Opcjonalnie, odświeżamy skrypty i CSS
    location.reload();
}


        </script>
        
        <button onclick="printContent()">Drukuj przepis</button>


        <button>Dodaj do jadłospisu</button>
        <button>Dodaj do listy zakupów</button>
    <h3>Autor:</h3>
    <div class="komentarz">
        <div class="avatar">
            <img src="{% static 'img/user.jfif' %}" alt="Avatar użytkownika">
        </div>
        <div>
             <p class="tresc"> {{ przepis.autorPrzepisu.nazwaUzytkownika }}</p>
             <p class="autor-data">Zobacz profil</p>
        </div>
    </div>
   
    <h3>Twoja Ocena</h3>
    <div class="stars">
        <input type="radio" id="star5" name="star" value="5" {% if ocena == 5 %}checked{% endif %}>
        <label for="star5"> Five Stars </label>
        <input type="radio" id="star4" name="star" value="4" {% if ocena == 4 %}checked{% endif %}>
        <label for="star4"> Four Stars </label>
        <input type="radio" id="star3" name="star" value="3" {% if ocena == 3 %}checked{% endif %}>
        <label for="star3"> Three Stars </label>
        <input type="radio" id="star2" name="star" value="2" {% if ocena == 2 %}checked{% endif %}>
        <label for="star2"> Two Stars </label>
        <input type="radio" id="star1" name="star" value="1" {% if ocena == 1 %}checked{% endif %}>
        <label for="star1"> One Star </label>
      </div>
      <script>
            var countStars = function () {
            var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            var checkedRadio = document.querySelector('.stars input:checked');
            const starValue = checkedRadio ? checkedRadio.value : null;
            
            if (starValue!=null && starValue!=0) {
                // Wykonaj POST na URL z `/stars`
                fetch(window.location.href + "stars", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken, // Dodaj CSRF token do nagłówka
                    },
                    body: JSON.stringify({ rating: starValue }), // Prześlij ocenę w treści
                }).then(response => response.json())
                .then(data => window.location.href = window.location.href.replace('/stars', '') )
             }
            };

            document.querySelector('.stars').addEventListener('click', countStars)
      </script>

    <h3>Komentarze</h3>
        {% for komentarz in komentarze %}
        <div class="komentarz">
            <div class="avatar">
                <img src="{% static 'img/user.jfif' %}" alt="Avatar użytkownika">
            </div>
            <div class="komentarz-tresc">
                <p class="autor-data">
                    <strong>{{ komentarz.uzytkownik.nazwaUzytkownika }}</strong> - {{ komentarz.dataKomentarza }}
                </p>
                <p class="tresc">
                    {{ komentarz.trescKomentarza }}
                </p>
            </div>
        </div>
    {% empty %}
        <p>Brak komentarzy.</p>
    {% endfor %}


    <h4>Dodaj komentarz</h4>
    <form method="POST" action="{% url 'addcomment' id=przepis.idPrzepis %}">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Dodaj komentarz</button>
    </form>

</div>
</div>

{% endblock %}
